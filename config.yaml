meta:
  engine: 4.1.0
  author: "hasbii"
units:
  a: 0.75
  mcuw: 17.78
  mcuh: 33
points:
  key.tags:
    - key
  zones:
    matrix:
      anchor:
        shift: [150, -150]
      columns:
        c6:
        c5:
        c4.key:
          stagger: u/8
        c3.key:
          stagger: u/8
        c2.key:
          stagger: -u/8
        c1.key:
          stagger: -u/8
      rows:
        r3:
        r2:
        r1:

    thumbfan:
      anchor:
        ref: matrix_c4_r3
        shift: [u/2, -u-a*2]
      columns:
        c5:
          rows:
            t1.skip: true
        c4:
          rows:
            t1.skip: true
        c3:
          key:
            splay: -12
            origin: [-u/2, -u/2]
          rows:
            t1.skip: true
        c2.key:
          splay: -12
          origin: [-u/2, -u/2]
        c1.key:
          splay: -12
          origin: [-u/2, -u/2]
      rows:
        t2:
        t1:

    mcu:
      key.tags:
        - helper
      anchor:
        - ref: matrix_c1_r1
          shift: [u+a*2, -u/4+a]

    display:
      key.tags:
        - display
      anchor:
        - ref: mcu
          shift: [0, -3.5]

    trrs:
      key.tags:
        - trrs
      anchor:
        - ref: mcu
          shift: [0, mcuh/2 + 7]

    board_screw_1:
      key.tags:
        - board_screw
      anchor:
        aggregate.parts:
          - ref: matrix_c1_r1
          - ref: matrix_c2_r1
          - ref: matrix_c1_r2
          - ref: matrix_c2_r2
    board_screw_2:
      key.tags:
        - board_screw
      anchor:
        aggregate.parts:
          - ref: thumbfan_c4_t1
          - ref: thumbfan_c5_t1
        shift: [0, -u/2]
    board_screw_3:
      key.tags:
        - board_screw
      anchor:
        aggregate.parts:
          - ref: thumbfan_c1_t1
          - ref: thumbfan_c2_t1
          - ref: thumbfan_c2_t2
          - ref: thumbfan_c1_t2
        shift: [0, 1]
    board_screw_4:
      key.tags:
        - board_screw
      anchor:
        aggregate.parts:
          - ref: matrix_c5_r1
          - ref: matrix_c6_r1
          - ref: matrix_c6_r2
          - ref: matrix_c5_r2
    board_screw_5:
      key.tags:
        - board_screw
      anchor:
        aggregate.parts:
          - ref: matrix_c5_r2
          - ref: matrix_c6_r2
          - ref: matrix_c6_r3
          - ref: matrix_c5_r3

outlines:
  _keycaps:
    - what: rectangle
      where: [key]
      size: 18
      fillet: 3
  _mcu:
    - what: rectangle
      where: [helper]
      size: [mcuw, mcuh]
  _display:
    - what: rectangle
      where: [display]
      size: [12, 38]
  _board_screw_heads:
    - what: circle
      where: [board_screw]
      radius: 4.3/2
  board:
    - what: outline
      name: _keycaps
    - what: outline
      name: _mcu
    - what: outline
      name: _display
    - what: polygon
      points:
        - ref: matrix_c6_r1
          shift: [-u/2-a, u/2+a]
        - ref: matrix_c5_r1
          shift: [u/2-a, u/2+a]
        - ref: matrix_c4_r1
          shift: [-u/2-a, u/2+a]
        - ref: matrix_c4_r1
          shift: [u/2-a, u/2+a]
        - ref: matrix_c3_r1
          shift: [-u/2-a, u/2+a]
        - ref: matrix_c3_r1
          shift: [u/2+a, u/2+a]
        - ref: matrix_c2_r1
          shift: [-u/2+a, u/2+a]
        - ref: mcu
          shift: [mcuw/2+a*3, 0]
          affect: [x]
        - ref: thumbfan_c2_t1
          shift: [0, u/2-a*3]
          affect: [y]
        - ref: thumbfan_c1_t1
          shift: [-u/2+a, u/2+a]
        - ref: thumbfan_c1_t1
          shift: [u/2+a, u/2+a]
        - ref: thumbfan_c1_t2
          shift: [u/2+a, -u/2-a]
        - ref: thumbfan_c1_t2
          shift: [-u/2-a, -u/2-a]
        - ref: thumbfan_c2_t2
          shift: [-u/2-a, -u/2-a]
        - ref: thumbfan_c3_t2
          shift: [-u/2-a, -u/2-a]
        - ref: thumbfan_c5_t2
          shift: [-u/2-a, -u/2-a]
        - ref: thumbfan_c5_t2
          shift: [-u/2-a, u/2-a*2]
        - ref: matrix_c6_r3
          shift: [-u/2-a, 0]
          affect: [x]
        - ref: matrix_c6_r1
          shift: [-u/2-a, u/2+a]
  preview:
    - what: outline
      name: board
    - what: outline
      name: _keycaps
      operation: stack
    - what: outline
      name: _mcu
      operation: stack
    - what: outline
      name: _display
      operation: stack
    - what: outline
      name: _board_screw_heads
      operation: stack

pcbs:
  hasbii_pcb:
    template: kicad8
    outlines:
      board:
        outline: board
    footprints:
      m2_screws:
        what: ceoloide/mounting_hole_npth
        where: /board_screw/
        params:
          hole_size: 4.6
          hole_drill: 2.2
      switches:
        what: ceoloide/switch_choc_v1_v2
        where:
          - /matrix_c[1-6]_r[1-3]/
          - /thumbfan_c[1-5]_t[1-2]/
        params:
          from: "{{colrow}}"
          to: "{{col.name}}"
          choc_v1_support: false
          include_plated_holes: false
          reversible: true
          include_stabilizer_pad: false
        adjust:
          rotate: 180
      diodes:
        what: ceoloide/diode_tht_sod123
        where: /key/
        params:
          from: "{{colrow}}"
          to: "{{row}}"
          reversible: true
        adjust:
          shift: [5.7, 0]
          rotate: 180
      mcu:
        what: ceoloide/mcu_supermini_nrf52840
        where: mcu
        params:
          reversible: true
          only_required_jumpers: true
          P2: "c1"
          P3: "c2"
          P4: "c3"
          P5: "c4"
          P6: "c5"
          P7: "c6"
          P21: "r1"
          P20: "r2"
          P19: "r3"
          P18: "t2"
          P15: "t1"
          P8: "SDA"
          P9: "SCL"
          P0: "DATA"
          use_rectangular_jumpers: false
      display:
        what: ceoloide/display_ssd1306
        where: display
        params:
          reversible: true
          SDA: "SDA"
          SCL: "SCL"
      trrs:
        what: ceoloide/trrs_pj320a
        where: trrs
        params:
          reversible: true
          symmetric: true
          TP: "VCC"
          R2: "DATA"
          SL: "GND"
      reset_switch:
        what: ceoloide/reset_switch_tht_top
        where: mcu
        params:
          reversible: true
          from: GND
          to: RST
        adjust:
          shift: [mcuw/2, -mcuh/2-5]
          rotate: 90
